name: Secure DVWA with Snyk and ZAP

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  security-tests:
    runs-on: ubuntu-latest

    steps:
    - name: ‚úÖ Checkout Code
      uses: actions/checkout@v3

    - name: ‚úÖ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'

    - name: ‚úÖ Install Snyk CLI
      run: npm install -g snyk

    - name: ‚úÖ Create .dcignore to exclude unnecessary dirs
      run: |
        echo "config/\ndocs/\nsetup/\nexternal/\ntests/\n*.md\n*.txt" > dvwa-code/.dcignore

    - name: ‚ö°Ô∏è Run Snyk Code PHP Scan on dvwa-code
      uses: snyk/actions/php@master
      timeout-minutes: 25
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --sarif-file-output=dvwa-code/snyk.sarif --all-projects --file=index.php

    - name: ‚§¥Ô∏è Upload Snyk SARIF to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: dvwa-code/snyk.sarif

    - name: üöÄ Run ZAP Baseline Scan on DVWA
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:8080/'
        docker_name: 'owasp/zap2docker-stable'
        cmd_options: '-a'

    - name: üìÅ Upload ZAP report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: zap.out
